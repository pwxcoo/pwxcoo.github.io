<!DOCTYPE html>
<html lang=en>
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <!-- fix Sina weibo image host temporarily -->
    <meta name="referrer" content="no-referrer" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="最近想用 JAVA 做一个 Web 应用。想爽一下这个目前”最流行”的语言。于是选择了 Spring Boot 作为项目框架做开发。感觉到Spring 确实是很成熟的框架了。 官方英文文档的阅读让我想去海底龙宫种一棵树。 Spring Boot Security Application 这个博主这篇14年文章给了我很多帮助。网上有翻译。但是那个是机器翻的。我还以为是屎呢。 用 Spring Sec">
<meta property="og:type" content="website">
<meta property="og:title" content="Spring Boot Security下的注册登录">
<meta property="og:url" content="https://blog.pwxcoo.com/archive/Spring%20Boot%20Security%E4%B8%8B%E7%9A%84%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95.html">
<meta property="og:site_name" content="PWXCOO">
<meta property="og:description" content="最近想用 JAVA 做一个 Web 应用。想爽一下这个目前”最流行”的语言。于是选择了 Spring Boot 作为项目框架做开发。感觉到Spring 确实是很成熟的框架了。 官方英文文档的阅读让我想去海底龙宫种一棵树。 Spring Boot Security Application 这个博主这篇14年文章给了我很多帮助。网上有翻译。但是那个是机器翻的。我还以为是屎呢。 用 Spring Sec">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-12-24T10:22:03.000Z">
<meta property="article:modified_time" content="2022-03-24T05:48:48.881Z">
<meta property="article:author" content="pwxcoo">
<meta property="article:tag" content="spring">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Spring Boot Security下的注册登录</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="PWXCOO" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body class="max-width mx-auto px3 ">
    
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="content index py4">
        
          <header id="header">
  <a href="/">
  
    
      <div id="logo" style="background-image: url(/images/logo.png);"></div>
    
  
    <div id="title">
      <h1>PWXCOO</h1>
    </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/">Home</a></li>
       
        <li><a href="/archives/">Archives</a></li>
       
        <li><a href="/toc/">Toc</a></li>
       
        <li><a href="/about/">About</a></li>
      
    </ul>
  </div>
</header>

        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  

  <div class="content" itemprop="articleBody">
      
          <p>最近想用 JAVA 做一个 Web 应用。想爽一下这个目前”最流行”的语言。于是选择了 Spring Boot 作为项目框架做开发。感觉到Spring 确实是很成熟的框架了。</p>
<p>官方英文文档的阅读让我想去海底龙宫种一棵树。</p>
<p><a target="_blank" rel="noopener" href="https://bartcode.co.uk/2014/12/spring-boot-security-application">Spring Boot Security Application</a> 这个博主这篇14年文章给了我很多帮助。网上有翻译。但是那个是机器翻的。我还以为是屎呢。</p>
<p>用 Spring Security 可以比较方便地开发应用中的几个问题: </p>
<ul>
<li>用户角色有用户，管理员。两者权限不一致</li>
<li>非管理员用户可以查看自己的信息，但不能窥视其他用户</li>
<li>定制表单登录和CSRF保护</li>
<li>“记住我”验证懒惰</li>
</ul>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul>
<li>从<a target="_blank" rel="noopener" href="https://start.spring.io/">start.spring.io</a>官网下载初始化应用。我下的是 gradle 的 spring boot 1.5.9 版本</li>
<li><a target="_blank" rel="noopener" href="https://spring.io/guides/gs/securing-web/">Securing a Web Application</a> 看一下官网上的入门 guide</li>
<li>数据库用的是 mysql</li>
<li>gradle配置: <figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">group</span> <span class="string">&#x27;com.pwxc&#x27;</span></span><br><span class="line">version <span class="string">&#x27;1.0-SNAPSHOT&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span>(<span class="string">&quot;org.springframework.boot:spring-boot-gradle-plugin:1.5.9.RELEASE&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apply plugin: <span class="string">&#x27;java&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;war&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;idea&#x27;</span></span><br><span class="line">apply plugin: <span class="string">&#x27;org.springframework.boot&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">sourceCompatibility</span> = <span class="number">1.8</span></span><br><span class="line"><span class="keyword">targetCompatibility</span> = <span class="number">1.8</span></span><br><span class="line"></span><br><span class="line">jar &#123;</span><br><span class="line">    baseName = <span class="string">&#x27;gs-serving-web-content&#x27;</span></span><br><span class="line">    version =  <span class="string">&#x27;0.1.0&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">repositories</span> &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">&quot;org.springframework.boot:spring-boot-starter-thymeleaf&quot;</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">&quot;org.springframework.boot:spring-boot-devtools&quot;</span>)</span><br><span class="line">    testCompile(<span class="string">&quot;junit:junit&quot;</span>)</span><br><span class="line">    testCompile(<span class="string">&quot;org.springframework.boot:spring-boot-starter-test&quot;</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">&quot;org.springframework.boot:spring-boot-starter-web&quot;</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">&quot;org.hsqldb:hsqldb&quot;</span>)</span><br><span class="line">    testCompile(<span class="string">&quot;org.springframework.security:spring-security-test&quot;</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">&quot;org.springframework.boot:spring-boot-starter-security&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JPA Data (We are going to use Repositories, Entities, Hibernate, etc...)</span></span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">&quot;org.springframework.boot:spring-boot-starter-data-jpa&quot;</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">&quot;com.h2database:h2&quot;</span>)</span><br><span class="line">    <span class="comment">// Use MySQL Connector-J</span></span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">&quot;mysql:mysql-connector-java&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="域模型"><a href="#域模型" class="headerlink" title="域模型"></a>域模型</h2>先建一个 User 的实体, Role 是一个枚举类，枚举 USER,ADMIN。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span> <span class="comment">// This tells Hibernate to make a table out of this class</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(generator=&quot;system-uuid&quot;, strategy= GenerationType.AUTO)</span></span><br><span class="line">    <span class="meta">@GenericGenerator(name = &quot;system-uuid&quot;, strategy = &quot;uuid&quot;)</span></span><br><span class="line">    <span class="meta">@Column(name=&quot;id&quot;, nullable = false, updatable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name=&quot;name&quot;, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name=&quot;email&quot;, nullable = false, unique = true)</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name=&quot;phone&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name=&quot;password&quot;, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name=&quot;role&quot;, nullable = false)</span></span><br><span class="line">    <span class="meta">@Enumerated(EnumType.STRING)</span></span><br><span class="line">    <span class="keyword">private</span> Role role;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name=&quot;createdAt&quot;, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long createdAt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name=&quot;updatedAt&quot;, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Long updatedAt;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>同时再写一个 data transfer object (DTO) 作为 Web 层和服务层的中介。既可以不让 User 泄露到 Web 层又方便我们做表单的验证。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserCreateForm</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;邮箱不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;名字不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;密码不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;重复密码不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String passwordRepeated;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Role</span> <span class="variable">role</span> <span class="operator">=</span> Role.USER;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>@NotEmpty 和 @NotNull 的区别在与前者会对空字符串或集合会返回 false, 后者只会验证 Null。</p>
<h2 id="服务层"><a href="#服务层" class="headerlink" title="服务层"></a>服务层</h2><p>UserService 接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    Optional&lt;User&gt; <span class="title function_">getUserById</span><span class="params">(String id)</span>;</span><br><span class="line"></span><br><span class="line">    Optional&lt;User&gt; <span class="title function_">getUserByEmail</span><span class="params">(String email)</span>;</span><br><span class="line"></span><br><span class="line">    Collection&lt;User&gt; <span class="title function_">getAllUsers</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    User <span class="title function_">create</span><span class="params">(UserCreateForm form)</span>;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure></p>
<p>UserService 接口的实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserServiceImpl</span><span class="params">(UserRepository IUserRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userRepository = IUserRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Optional&lt;User&gt; <span class="title function_">getUserById</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findOneById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Optional&lt;User&gt; <span class="title function_">getUserByEmail</span><span class="params">(String email)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findOneByEmail(email);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;User&gt; <span class="title function_">getAllUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findAll(<span class="keyword">new</span> <span class="title class_">Sort</span>(<span class="string">&quot;email&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">create</span><span class="params">(UserCreateForm form)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">timestamp</span> <span class="operator">=</span> Long.valueOf(date.getTime()/<span class="number">1000</span>);</span><br><span class="line">        user.setEmail(form.getEmail());</span><br><span class="line">        user.setName(form.getName());</span><br><span class="line">        user.setPassword(<span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>().encode(form.getPassword()));</span><br><span class="line">        user.setRole(form.getRole());</span><br><span class="line">        user.setCreatedAt(timestamp);</span><br><span class="line">        user.setUpdatedAt(timestamp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userRepository.save(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure></p>
<p>dao 层 UserRepository 直接用Jpa，实现了基本所有的简单数据库操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;User, Long&gt; &#123;</span><br><span class="line">    Optional&lt;User&gt; <span class="title function_">findOneByEmail</span><span class="params">(String email)</span>;</span><br><span class="line">    Optional&lt;User&gt; <span class="title function_">findOneById</span><span class="params">(String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Web层"><a href="#Web层" class="headerlink" title="Web层"></a>Web层</h2><p>首页 “/“ 随便写一下就好了，我是写了几个到”/register”, “/login”的链接的。我把 login 和 register 都放在一个Controller 里。这是我的 LoginAndRegisterController<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginAndRegisterController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(LoginAndRegisterController.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserCreateFormValidator userCreateFormValidator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LoginAndRegisterController</span><span class="params">(UserService userService, UserCreateFormValidator userCreateFormValidator)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userService = userService;</span><br><span class="line">        <span class="built_in">this</span>.userCreateFormValidator = userCreateFormValidator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InitBinder(&quot;form&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initBinder</span><span class="params">(WebDataBinder binder)</span> &#123;</span><br><span class="line">        binder.addValidators(userCreateFormValidator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/register&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRegisterPage</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;form&quot;</span>, <span class="keyword">new</span> <span class="title class_">UserCreateForm</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;register&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/register&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handleUserCreateForm</span><span class="params">(Model model, <span class="meta">@Valid</span> <span class="meta">@ModelAttribute(&quot;form&quot;)</span> UserCreateForm form, BindingResult bindingResult)</span> &#123;</span><br><span class="line">        LOGGER.debug(<span class="string">&quot;用户提交的表单: &#123;&#125;, 验证结果: &#123;&#125;&quot;</span>, form, bindingResult);</span><br><span class="line">        <span class="keyword">if</span>(bindingResult.hasErrors()) &#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;出错啦&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;register&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            userService.create(form);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DataIntegrityViolationException e) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">&quot;保存时出错，邮箱已经注册了！&quot;</span>, e);</span><br><span class="line">            bindingResult.reject(<span class="string">&quot;email.exists&quot;</span>, <span class="string">&quot;Email already exists&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;register&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/login&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLoginPage</span><span class="params">(Model model, <span class="meta">@RequestParam</span> Optional&lt;String&gt; error)</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;error&quot;</span>, error);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里还有比较重要的注册表单的验证类 UserCreateFormValidator, 在使用的时候还要用 @InitBinder 绑定一下。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserCreateFormValidator</span> <span class="keyword">implements</span> <span class="title class_">Validator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserCreateFormValidator</span><span class="params">(UserService userService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> clazz.equals(UserCreateForm.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validate</span><span class="params">(Object target, Errors errors)</span> &#123;</span><br><span class="line">        <span class="type">UserCreateForm</span> <span class="variable">form</span> <span class="operator">=</span> (UserCreateForm)target;</span><br><span class="line">        validatePasswords(errors, form);</span><br><span class="line">        validateEmail(errors, form);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">validatePasswords</span><span class="params">(Errors errors, UserCreateForm form)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!form.getPassword().equals(form.getPasswordRepeated())) &#123;</span><br><span class="line">            errors.reject(<span class="string">&quot;password.no_match&quot;</span>, <span class="string">&quot;两次密码不一致!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">validateEmail</span><span class="params">(Errors errors, UserCreateForm form)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (userService.getUserByEmail(form.getEmail()).isPresent()) &#123;</span><br><span class="line">            errors.rejectValue(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;email.exists&quot;</span>, <span class="string">&quot;该邮箱已被注册!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这样注册功能其实是已经完成了。有注册就有登陆，登录之后问题有点复杂了，要保持登录状态，remember-me, 基于URL的安全保护和基于方法级的安全保护。</p>
<h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><p>在现在版本里在 Sercurity 配置里开启了 @EnableWebSecurity，表单里会自动填充 csrf 如果没有的话，自己加一个就好了，我用thymeleaf 模板引擎里，加一句就好了。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">th:name</span>=<span class="string">&quot;$&#123;_csrf.parameterName&#125;&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;_csrf.token&#125;&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="认证配置"><a href="#认证配置" class="headerlink" title="认证配置"></a>认证配置</h2><p>使用Sercurity Boot 里必须要配置的，不然的话，每次打开网页他就会一直叫你验证，可以说是，超级不友好了。SecurityConfig类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**定义安全策略*/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                    <span class="comment">//这里其实就是基于URL的安全配置</span></span><br><span class="line">                    .antMatchers(<span class="string">&quot;/static/css/**&quot;</span>, <span class="string">&quot;/static/js/**&quot;</span>, <span class="string">&quot;/static/images/**&quot;</span>).permitAll()  <span class="comment">//静态文件不认证</span></span><br><span class="line">                    .antMatchers(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/register&quot;</span>).permitAll()  <span class="comment">//首页和注册页面不认证</span></span><br><span class="line">                    .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasAuthority(<span class="string">&quot;ADMIN&quot;</span>) <span class="comment">//只有管理员才能访问</span></span><br><span class="line">                    .anyRequest().fullyAuthenticated()  <span class="comment">//别的全都要认证</span></span><br><span class="line">                .and()</span><br><span class="line">                    .formLogin()    <span class="comment">//通过表单验证</span></span><br><span class="line">                    .loginPage(<span class="string">&quot;/login&quot;</span>)    <span class="comment">//未认证用户访问需要认证界面自动跳转到 &quot;/login&quot;</span></span><br><span class="line">                    .failureUrl(<span class="string">&quot;/login?error&quot;</span>)</span><br><span class="line">                    .usernameParameter(<span class="string">&quot;email&quot;</span>)</span><br><span class="line">                    .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                    .logout()</span><br><span class="line">                    .logoutUrl(<span class="string">&quot;/logout&quot;</span>)</span><br><span class="line">                    .deleteCookies(<span class="string">&quot;remember-me&quot;</span>)   </span><br><span class="line">                    .logoutSuccessUrl(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">                    .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                    .rememberMe()</span><br><span class="line">                    .tokenValiditySeconds(<span class="number">1209600</span>); <span class="comment">//remember-me的time-out默认我试了一下是14天。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**定义认证用户信息获取来源，密码校验规则等*/</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureGlobal</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth</span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                .passwordEncoder(<span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//jdbcAuthentication从数据库中获取，但是默认是以security提供的表结构</span></span><br><span class="line">        <span class="comment">//usersByUsernameQuery 指定查询用户SQL</span></span><br><span class="line">        <span class="comment">//authoritiesByUsernameQuery 指定查询权限SQL</span></span><br><span class="line">        <span class="comment">//auth.jdbcAuthentication().dataSource(dataSource).usersByUsernameQuery(query).authoritiesByUsernameQuery(query);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//注入userDetailsService，需要实现userDetailsService接口</span></span><br><span class="line">        <span class="comment">//auth.userDetailsService(userDetailsService);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个配置一开始让人感觉很头大，我把难受的地方都加了注释了。UserDetailsService这个接口是Spring Security用来验证当前用户，是系统给的。需要实现一下这个接口:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CurrentUserDetailsService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(CurrentUserDetailsService.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CurrentUserDetailsService</span><span class="params">(UserService userService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String email)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;Authenticating user with email=&#123;&#125;&quot;</span>, email.replaceFirst(<span class="string">&quot;@.*&quot;</span>, <span class="string">&quot;@***&quot;</span>));</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getUserByEmail(email).orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(String.format(<span class="string">&quot;User with email=%s was not found&quot;</span>, email)));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CurrentUser</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserDetails 是 Spring 用来记录当前用户，就是用户登录完之后，系统里保存就是当前这个用户的 UserDetails，所以可以在不同的用户端显示不同的内容。这个 UserDetails 对每个应用是不一样的，因为每个应用有不同的业务逻辑，所以继承一波UserDetails，写一个属于自己的 UserDetails。就是 CurrentUser:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CurrentUser</span> <span class="keyword">extends</span> <span class="title class_">org</span>.springframework.security.core.userdetails.User &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CurrentUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(user.getEmail(), user.getPassword(), AuthorityUtils.createAuthorityList(user.getRole().toString()));</span><br><span class="line">        <span class="built_in">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> user.getId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Role <span class="title function_">getRole</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> user.getRole();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果访问”/user/{id}”, A 用户访问了 B 用户的 id，此时应该需要拦截，但是如果在 URL 是不方便设置的，可以用方法级的拦截。调用 getprincipal()就可得到当前用户的实例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;@currentUserServiceImpl.canAccessUser(principal, #id)&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getUserPage</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="在视图中得到当前用户"><a href="#在视图中得到当前用户" class="headerlink" title="在视图中得到当前用户"></a>在视图中得到当前用户</h2><p>编写一个用 @ControllerAdvice 和 @ModelAttribute 注释的类，就不必每次都去获取这个实例了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CurrentUserControllerAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ModelAttribute(&quot;currentUser&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CurrentUser <span class="title function_">getCurrentUser</span><span class="params">(Authentication authentication)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (authentication == <span class="literal">null</span>) ? <span class="literal">null</span> : (CurrentUser) authentication.getPrincipal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a target="_blank" rel="noopener" href="https://github.com/pwxcoo/ProvokeQuestion/tree/974dda0bf9bda3b66ab16f8338209f95e9059459">代码</a></p>

        
  </div>
</article>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2022 pwxcoo
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/toc/">Toc</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- mathjax -->
<script src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=default">
  MathJax.Hub.Config({
   tex2jax: {
   inlineMath: [['$','$'],["\\(","\\)"]],
   displayMath: [['\\[','\\]'], ['$$','$$']],
   },
});
</script>
<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-123052529-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'pwxcoo';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


